<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Groq Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/phosphor-icons"></script>
  <style>
    :root[data-theme='dark'] {
      --bg: #0e0e0f;
      --panel: #1a1a1c;
      --border: #2b2b2e;
      --text: #ffffff;
      --accent: #f55036;
      --hover: #27272a;
      --user-msg: #2b2b2e;
      --storage-bg: #3f3f46;
      --font-size-base: 16px;
      --spacing-base: 1rem;
    }
    :root[data-theme='light'] {
      --bg: #f6f6f6;
      --panel: #ffffff;
      --border: #d9d9d9;
      --text: #111111;
      --accent: #f55036;
      --hover: #e5e5e5;
      --user-msg: #e5e5e5;
      --storage-bg: #e5e7eb;
      --font-size-base: 16px;
      --spacing-base: 1rem;
    }

    /* Font Size Modifiers */
    :root[data-font='small'] { --font-size-base: 13px; }
    :root[data-font='medium'] { --font-size-base: 16px; }
    :root[data-font='large'] { --font-size-base: 18px; }

    /* Compact Mode Modifiers */
    :root[data-compact='true'] { --spacing-base: 0.5rem; }

    body { 
        background: var(--bg); 
        color: var(--text); 
        transition: background 0.2s, color 0.2s; 
        font-size: var(--font-size-base);
    }

    .chat-bubble { 
        border: 1px solid var(--border); 
        background: var(--panel); 
        padding: var(--spacing-base);
    }

    .btn-icon { padding: 0.5rem; border-radius: 0.375rem; transition: background 0.2s; cursor: pointer; }
    .btn-icon:hover { background: var(--hover); }
    
    #sidebar { transition: transform 0.3s ease-in-out, width 0.3s ease-in-out, opacity 0.3s; }
    
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-track { background: transparent; }

    .typing-indicator { display: flex; align-items: center; gap: 4px; padding: 4px 8px; }
    .typing-dot {
      width: 6px; height: 6px; background: var(--text); border-radius: 50%; opacity: 0.4;
      animation: typing 1.4s infinite ease-in-out both;
    }
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    @keyframes typing {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
    
    .modal-backdrop { background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); }
    .active-chat { background-color: var(--hover); border-color: var(--accent); border-left-width: 4px; }
    
    /* Message Actions */
    .message-actions { 
        display: flex; 
        gap: 0.5rem; 
        margin-top: 0.5rem; 
        padding-top: 0.5rem; 
        border-top: 1px solid var(--border); 
        opacity: 0.7; 
        transition: opacity 0.2s;
    }
    .message-actions:hover { opacity: 1; }
    .action-btn { 
        display: flex; 
        align-items: center; 
        gap: 0.25rem; 
        font-size: 0.75em; 
        padding: 0.25rem 0.5rem; 
        border-radius: 0.25rem; 
        color: var(--text);
        opacity: 0.8;
        transition: background 0.2s; 
    }
    .action-btn:hover { background: var(--hover); opacity: 1; }
    
    /* Storage Bar */
    .storage-bar-container { background-color: var(--storage-bg); border-radius: 9999px; height: 8px; overflow: hidden; }
    .storage-bar-fill { background-color: var(--accent); height: 100%; transition: width 0.3s ease-in-out; }

    /* Settings Tabs */
    .tab-btn { 
        text-align: left; 
        padding: 0.75rem 1rem; 
        border-radius: 0.5rem; 
        opacity: 0.7; 
        transition: all 0.2s;
        font-size: 0.9em;
    }
    .tab-btn:hover { background: var(--hover); opacity: 1; }
    .tab-btn.active { 
        background: var(--accent); 
        color: white; 
        opacity: 1; 
        font-weight: 600;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    input[type="range"] {
        accent-color: var(--accent);
    }
  </style>
</head>
<body class="h-screen flex overflow-hidden">

  <!-- Firebase Config & Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, collection, addDoc, getDocs, onSnapshot, query, orderBy, serverTimestamp, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // 1. YOUR ACTUAL CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyAI80ozAVa7aQ8cYt-RvoydKmH46h7v3aY",
    authDomain: "streamflix-ae76b.firebaseapp.com",
    projectId: "streamflix-ae76b",
    storageBucket: "streamflix-ae76b.firebasestorage.app",
    messagingSenderId: "784256694280",
    appId: "1:784256694280:web:d704204f8b8a304b0a39bd",
    measurementId: "G-B8FDVBTNK7"
    };

    // Global App Constants
    const appId = "streamflix";
    window.db = null;
    window.auth = null;
    window.userId = null;
    window.currentChatId = null;

    // 2. INITIALIZE FIREBASE
    async function initFirebase() {
        const app = initializeApp(firebaseConfig);
        window.auth = getAuth(app);
        window.db = getFirestore(app);

        // State Listener: Automatically logs in & loads history
      // Replace the old onAuthStateChanged block with this:
onAuthStateChanged(window.auth, (user) => {
    if (user) {
        window.userId = user.uid;
        console.log("Streamflix Cloud Active:", user.uid);

        // This function waits until the UI script has defined the necessary functions
        const retryLoad = () => {
            if (typeof window.loadRecentChats === "function") {
                window.loadRecentChats();
            } else {
                console.log("Waiting for UI script to initialize...");
                setTimeout(retryLoad, 100); // Check again in 100ms
            }
        };
        retryLoad();
        
    } else {
        signInAnonymously(window.auth);
    }
});
    }

    // 3. CREATE A NEW CHAT
    window.createNewChat = async (firstMessageText) => {
        if (!window.userId || !window.db) return null;
        
        const chatsRef = collection(window.db, `artifacts/${appId}/users/${window.userId}/conversations`);
        const title = firstMessageText.substring(0, 30) + (firstMessageText.length > 30 ? "..." : "");
        
        const newChatRef = await addDoc(chatsRef, { 
            title: title, 
            updatedAt: serverTimestamp(), 
            createdAt: serverTimestamp() 
        });
        
        window.currentChatId = newChatRef.id;
        return newChatRef.id;
    }

    // 4. SAVE MESSAGE TO CLOUD
    window.saveMessageToFirestore = async (text, role, isImage = false) => {
        if (!window.userId || !window.db) return;
        
        if (!window.currentChatId) {
            await window.createNewChat(isImage ? "Image Analysis" : text);
        }

        const messagesRef = collection(window.db, `artifacts/${appId}/users/${window.userId}/conversations/${window.currentChatId}/messages`);
        
        await addDoc(messagesRef, { 
            text: text, 
            role: role, 
            isImage: isImage, 
            timestamp: serverTimestamp() 
        });

        // Update the "Last Activity" time for the chat
        const chatRef = doc(window.db, `artifacts/${appId}/users/${window.userId}/conversations/${window.currentChatId}`);
        await updateDoc(chatRef, { updatedAt: serverTimestamp() });
    }

    // 5. DELETE CHAT FROM CLOUD
    window.deleteChat = async (chatId) => {
        if (!confirm("Delete this conversation forever?")) return;
        
        const chatDoc = doc(window.db, `artifacts/${appId}/users/${window.userId}/conversations/${chatId}`);
        await deleteDoc(chatDoc);
        
        if (window.currentChatId === chatId) {
            window.currentChatId = null;
            document.getElementById('messages').innerHTML = ''; // Clear chat area
        }
    };

    // 6. FETCH CHATS FROM CLOUD (The missing bridge)
window.fetchChatsFromFirestore = () => {
    if (!window.userId || !window.db) return;

    const chatsRef = collection(window.db, `artifacts/${appId}/users/${window.userId}/conversations`);
    // Order by most recent activity
    const q = query(chatsRef, orderBy("updatedAt", "desc"));

    // This "onSnapshot" listens for real-time changes
    onSnapshot(q, (snapshot) => {
        const chats = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));
        
        console.log("Database Sync: Found", chats.length, "chats");

        // Send the data back to the UI script's render function
        if (typeof window.renderChatList === "function") {
            window.renderChatList(chats);
        }
    }, (error) => {
        console.error("Firestore sync error:", error);
    });
};

    // Launch connection
    initFirebase();
</script>

  <!-- LEFT: Sidebar -->
  <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-[var(--panel)] border-r border-[var(--border)] flex flex-col transform -translate-x-full lg:relative lg:translate-x-0 lg:w-64">
    <div class="p-4 flex items-center justify-between border-b border-[var(--border)]">
      <h2 class="text-xl font-semibold">Menu</h2>
      <button id="mobileCloseBtn" class="lg:hidden btn-icon text-[var(--text)]">
        <i class="ph-x text-xl"></i>
      </button>
    </div>
    
    <div class="p-4 space-y-2 overflow-y-auto flex-1">
      <button id="newChatBtn" class="w-full text-left p-3 rounded bg-[var(--accent)] text-white hover:opacity-90 flex items-center gap-2 transition shadow-md font-medium">
        <i class="ph-plus-circle text-lg"></i> New Chat
      </button>
      
      <div class="relative">
          <button id="toggleSearchBtn" class="w-full text-left p-3 rounded border border-[var(--border)] hover:bg-[var(--hover)] flex items-center gap-2 transition">
            <i class="ph-magnifying-glass"></i> Search Chats
          </button>
          <input id="searchInput" type="text" class="hidden w-full mt-2 p-2 rounded bg-[var(--bg)] border border-[var(--border)] text-sm focus:outline-none focus:border-[var(--accent)]" placeholder="Filter chats..." />
      </div>
      
      <div class="mt-6">
        <h3 class="text-xs font-bold text-gray-500 uppercase mb-2 px-1">History</h3>
        <div id="recentChatsList" class="space-y-1">
            <div class="text-xs text-[var(--border)] p-2 italic">Loading history...</div>
        </div>
      </div>
    </div>
    
    <!-- User ID Display (Hidden by default) -->
    <div id="userIdContainer" class="hidden px-4 py-2 text-[10px] opacity-50 font-mono text-center border-t border-[var(--border)]">
        <span id="userIdDisplay">Connecting...</span>
    </div>

    <div class="p-4 border-t border-[var(--border)]">
      <button id="settingsBtn" class="w-full text-left p-2 rounded hover:bg-[var(--hover)] flex items-center gap-2">
        <i class="ph-gear"></i> Settings
      </button>
    </div>
  </aside>

  <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden backdrop-blur-sm transition-opacity opacity-0"></div>

  <!-- CENTER: Main Content -->
  <main class="flex-1 flex flex-col min-w-0 bg-[var(--bg)] relative">
    
    <!-- Header -->
    <header class="flex items-center justify-between p-3 md:p-4 border-b border-[var(--border)] bg-[var(--panel)] z-10">
      <div class="flex items-center gap-3">
        <button id="hamburger" class="btn-icon text-[var(--text)] border border-[var(--border)]">
          <i class="ph-list text-lg"></i>
        </button>
        <h1 class="text-lg md:text-xl font-bold">Groq Chat</h1>
      </div>
      
      <div class="flex items-center gap-2 md:gap-3">
        <select id="modelSelect" class="p-1.5 md:p-2 rounded bg-[var(--panel)] border border-[var(--border)] text-xs md:text-sm max-w-[200px] focus:outline-none focus:border-[var(--accent)]">
          <option value="llama-3.1-8b-instant">Llama 3.1 8B Instant</option>
          <option value="llama-3.3-70b-versatile" selected>Llama 3.3 70B Versatile</option>
          <option value="meta-llama/llama-4-maverick-17b-128e-instruct">Llama 4 Maverick 17B</option>
          <option value="meta-llama/llama-4-scout-17b-16e-instruct">Llama 4 Scout 17B (10M Context)</option>
          <option value="meta-llama/llama-guard-4-12b">Llama Guard 4 12B</option>
        </select>
        <button id="themeToggle" class="btn-icon border border-[var(--border)]">
          <i class="ph-moon"></i>
        </button>
      </div>
    </header>

    <!-- Content Area -->
    <div class="flex-1 flex overflow-hidden relative">
      
      <!-- Chat Area -->
      <div id="chatContainer" class="flex-1 flex flex-col relative">
        <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4 scroll-smooth">
            <!-- Initial Welcome -->
            <div id="welcomeMessage" class="chat-bubble p-6 rounded-lg max-w-2xl mx-auto mt-10 text-center border-none bg-gradient-to-br from-[var(--panel)] to-[var(--bg)] shadow-lg">
                <div class="bg-[var(--accent)] w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="ph-lightning text-2xl text-white"></i>
                </div>
                <h3 class="text-xl font-bold mb-2">Welcome to Groq Chat</h3>
                <p class="opacity-70 mb-4">Experience ultra-fast inference with Llama 3 & 4 models.</p>
                <div class="text-xs opacity-50 border-t border-[var(--border)] pt-4">
                    Simulated environment â€¢ No Groq API Key required
                </div>
            </div>
        </div>

        <!-- File Preview Area -->
        <div id="attachmentPreview" class="hidden px-4 py-2 bg-[var(--panel)] border-t border-[var(--border)] flex items-center gap-2">
            <div class="relative group">
                <img id="previewImg" src="" class="h-16 w-16 object-cover rounded border border-[var(--border)]" />
                <button id="removeAttachment" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow hover:bg-red-600">
                    <i class="ph-x text-xs"></i>
                </button>
            </div>
            <span id="fileName" class="text-xs opacity-70 truncate max-w-[200px]"></span>
        </div>

        <!-- Input Area -->
        <div class="p-3 md:p-4 border-t border-[var(--border)] bg-[var(--panel)]">
          <div class="max-w-3xl mx-auto flex items-end gap-2">
            
            <div class="relative">
              <button id="plusMenuBtn" class="btn-icon border border-[var(--border)] h-[42px] w-[42px] flex items-center justify-center hover:bg-[var(--hover)]">
                <i class="ph-plus text-lg"></i>
              </button>
              <div id="plusMenu" class="absolute bottom-full left-0 mb-2 hidden w-56 bg-[var(--panel)] border border-[var(--border)] p-1 rounded shadow-xl z-20">
                <button id="addPhotoBtn" class="block w-full text-left p-2 rounded hover:bg-[var(--hover)] text-sm flex items-center gap-2">
                    <i class="ph-image text-lg text-green-500"></i> Add Photo
                </button>
                <button id="addFileBtn" class="block w-full text-left p-2 rounded hover:bg-[var(--hover)] text-sm flex items-center gap-2">
                    <i class="ph-file text-lg text-blue-500"></i> Add File
                </button>
              </div>
            </div>

            <textarea id="userInput" class="flex-1 p-3 border rounded-lg border-[var(--border)] bg-[var(--bg)] resize-none focus:outline-none focus:ring-1 focus:ring-[var(--accent)] max-h-32" rows="1" placeholder="Message Groq..."></textarea>
            
            <button id="sendBtn" class="p-3 bg-[var(--accent)] text-white rounded-lg hover:opacity-90 transition flex items-center justify-center h-[42px] w-[42px]">
              <i class="ph-paper-plane-right text-lg"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- ADVANCED SETTINGS MODAL -->
  <div id="settingsModal" class="fixed inset-0 z-[60] hidden">
      <div class="absolute inset-0 modal-backdrop" id="settingsBackdrop"></div>
      <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[95%] max-w-2xl h-[80vh] bg-[var(--panel)] border border-[var(--border)] rounded-xl shadow-2xl flex flex-col overflow-hidden">
          
          <!-- Modal Header -->
          <div class="p-4 border-b border-[var(--border)] flex justify-between items-center">
              <h2 class="text-xl font-bold">Settings</h2>
              <button id="closeSettings" class="btn-icon"><i class="ph-x text-lg"></i></button>
          </div>

          <!-- Modal Body (Flex) -->
          <div class="flex flex-1 overflow-hidden">
              
              <!-- Sidebar Tabs -->
              <div class="w-1/4 bg-[var(--bg)] border-r border-[var(--border)] p-2 space-y-1 overflow-y-auto">
                  <button class="tab-btn w-full active" data-tab="general">General</button>
                  <button class="tab-btn w-full" data-tab="ai-config">AI Config</button>
                  <button class="tab-btn w-full" data-tab="interface">Interface</button>
                  <button class="tab-btn w-full" data-tab="data">Data</button>
              </div>

              <!-- Content Area -->
              <div class="w-3/4 p-6 overflow-y-auto bg-[var(--panel)]">
                  
                  <!-- 1. GENERAL -->
                  <div id="tab-general" class="tab-content active space-y-6">
                      <div>
                          <h3 class="text-sm font-bold uppercase opacity-70 mb-2">System Prompt</h3>
                          <textarea id="systemPrompt" class="w-full p-3 rounded bg-[var(--bg)] border border-[var(--border)] text-sm resize-y" rows="4" placeholder="You are a helpful AI..."></textarea>
                          <p class="text-xs opacity-50 mt-1">Define how the AI should behave.</p>
                      </div>
                      <div>
                          <h3 class="text-sm font-bold uppercase opacity-70 mb-2">Default Model</h3>
                          <select id="defaultModelSetting" class="w-full p-2 rounded bg-[var(--bg)] border border-[var(--border)] text-sm">
                              <option value="llama-3.3-70b-versatile">Llama 3.3 70B Versatile</option>
                              <option value="llama-3.1-8b-instant">Llama 3.1 8B Instant</option>
                              <option value="meta-llama/llama-4-maverick-17b-128e-instruct">Llama 4 Maverick</option>
                          </select>
                      </div>
                  </div>

                  <!-- 2. AI CONFIG -->
                  <div id="tab-ai-config" class="tab-content space-y-6">
                      <p class="text-xs bg-[var(--bg)] p-3 rounded border border-[var(--border)]">
                          <i class="ph-info"></i> These settings control the creativity and length of the AI's responses.
                      </p>
                      
                      <!-- Temperature -->
                      <div>
                          <div class="flex justify-between mb-1">
                              <label class="text-sm font-bold">Temperature</label>
                              <span id="tempValue" class="text-xs opacity-70">0.7</span>
                          </div>
                          <input type="range" id="tempInput" min="0" max="1" step="0.1" value="0.7" class="w-full h-2 bg-[var(--bg)] rounded-lg appearance-none cursor-pointer">
                          <div class="flex justify-between text-xs opacity-50 mt-1">
                              <span>Precise</span>
                              <span>Creative</span>
                          </div>
                      </div>

                      <!-- Max Tokens -->
                      <div>
                           <div class="flex justify-between mb-1">
                              <label class="text-sm font-bold">Max Tokens</label>
                           </div>
                           <input type="number" id="maxTokensInput" value="2048" class="w-full p-2 rounded bg-[var(--bg)] border border-[var(--border)] text-sm">
                           <p class="text-xs opacity-50 mt-1">Limit the length of the response.</p>
                      </div>

                      <!-- Top P -->
                      <div>
                          <div class="flex justify-between mb-1">
                              <label class="text-sm font-bold">Top P</label>
                              <span id="topPValue" class="text-xs opacity-70">0.9</span>
                          </div>
                          <input type="range" id="topPInput" min="0" max="1" step="0.1" value="0.9" class="w-full h-2 bg-[var(--bg)] rounded-lg appearance-none cursor-pointer">
                      </div>

                      <!-- Stop Sequences -->
                      <div>
                          <label class="text-sm font-bold block mb-1">Stop Sequences</label>
                          <input type="text" id="stopSequencesInput" placeholder='e.g. "User:", "###"' class="w-full p-2 rounded bg-[var(--bg)] border border-[var(--border)] text-sm">
                          <p class="text-xs opacity-50 mt-1">Comma separated list of text that stops generation.</p>
                      </div>
                  </div>

                  <!-- 3. INTERFACE -->
                  <div id="tab-interface" class="tab-content space-y-6">
                      <!-- Font Size -->
                      <div>
                          <label class="text-sm font-bold block mb-2">Font Size</label>
                          <select id="fontSizeSelect" class="w-full p-2 rounded bg-[var(--bg)] border border-[var(--border)] text-sm">
                              <option value="small">Small</option>
                              <option value="medium" selected>Medium (Default)</option>
                              <option value="large">Large</option>
                          </select>
                      </div>

                      <!-- Compact Mode -->
                      <div class="flex items-center justify-between">
                          <div>
                              <span class="font-bold text-sm">Compact Mode</span>
                              <p class="text-xs opacity-50">Reduce spacing in chat bubbles.</p>
                          </div>
                          <input type="checkbox" id="compactModeToggle" class="w-5 h-5 accent-[var(--accent)]">
                      </div>

                      <!-- Enter to Send -->
                      <div class="flex items-center justify-between">
                          <div>
                              <span class="font-bold text-sm">Enter to Send</span>
                              <p class="text-xs opacity-50">If off, use Ctrl+Enter to send.</p>
                          </div>
                          <input type="checkbox" id="enterToSendToggle" checked class="w-5 h-5 accent-[var(--accent)]">
                      </div>

                       <!-- Show User ID -->
                       <div class="flex items-center justify-between">
                          <div>
                              <span class="font-bold text-sm">Show User ID</span>
                              <p class="text-xs opacity-50">Display your unique ID in sidebar.</p>
                          </div>
                          <input type="checkbox" id="showUserIdToggle" class="w-5 h-5 accent-[var(--accent)]">
                      </div>
                  </div>

                  <!-- 4. DATA -->
                  <div id="tab-data" class="tab-content space-y-6">
                       <!-- Storage Bar -->
                       <div>
                          <h3 class="text-sm font-bold mb-2">Local Browser Storage</h3>
                          <div class="flex items-center justify-between text-xs mb-1 opacity-70">
                              <span id="storageUsedEl">0 B used</span>
                              <span id="storageCapacityEl">Calculating...</span>
                          </div>
                          <div class="storage-bar-container">
                              <div id="storageFillEl" class="storage-bar-fill" style="width: 0%;"></div>
                          </div>
                          <p class="text-xs opacity-50 mt-2">Tracks space used by local settings/cache.</p>
                      </div>

                      <hr class="border-[var(--border)]">

                      <div>
                          <h3 class="text-sm font-bold mb-2">Manage Cloud Data</h3>
                          <div class="flex flex-col gap-3">
                              <button id="exportDataBtn" onclick="window.exportAllData()" class="w-full p-3 rounded border border-[var(--border)] hover:bg-[var(--hover)] flex items-center justify-center gap-2 text-sm">
                                  <i class="ph-download"></i> Export All Chat Data (JSON)
                              </button>
                              
                              <button id="clearHistoryBtn" onclick="window.clearAllHistory()" class="w-full p-3 rounded bg-red-500/10 text-red-500 border border-red-500/20 hover:bg-red-500/20 flex items-center justify-center gap-2 text-sm">
                                  <i class="ph-trash"></i> Clear Cloud History
                              </button>
                          </div>
                      </div>
                  </div>

              </div>
          </div>

          <!-- Footer -->
          <div class="p-4 border-t border-[var(--border)] flex justify-end gap-2 bg-[var(--bg)]">
              <button onclick="toggleSettings()" class="px-4 py-2 rounded border border-[var(--border)] hover:bg-[var(--hover)] text-sm">Cancel</button>
              <button id="saveSettingsBtn" class="px-6 py-2 rounded bg-[var(--accent)] text-white text-sm font-medium shadow-lg">Save Changes</button>
          </div>
      </div>
  </div>

  <input type="file" id="fileInput" class="hidden" accept="image/*, .txt, .js, .html, .css, .md">

<script>
  const API_KEY = "AIzaSyAR5w9sBP5OMN4wXDBR7jQrrHVylmt0do8"; 
  const GEMINI_ENDPOINT = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;

  const messages = document.getElementById('messages');
  const userInput = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');
  const modelSelect = document.getElementById('modelSelect');
  let currentFile = null; 

  /* Theme */
  const root = document.documentElement;
  const themeToggle = document.getElementById('themeToggle');
  const icon = themeToggle.querySelector('i');
  function setTheme(theme) {
    root.dataset.theme = theme;
    localStorage.setItem('theme', theme);
    icon.className = theme === 'dark' ? 'ph-sun' : 'ph-moon';
  }
  themeToggle.onclick = () => setTheme(root.dataset.theme === 'dark' ? 'light' : 'dark');
  setTheme(localStorage.getItem('theme') || 'dark');

  /* Sidebar */
  const hamburger = document.getElementById('hamburger');
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebarOverlay');
  const mobileCloseBtn = document.getElementById('mobileCloseBtn');
  let isSidebarOpenDesktop = true;
  function toggleSidebar() {
    const isMobile = window.innerWidth < 1024;
    if (isMobile) {
      const isClosed = sidebar.classList.contains('-translate-x-full');
      if (isClosed) {
        sidebar.classList.remove('-translate-x-full');
        overlay.classList.remove('hidden');
        setTimeout(() => overlay.classList.remove('opacity-0'), 10);
      } else {
        sidebar.classList.add('-translate-x-full');
        overlay.classList.add('opacity-0');
        setTimeout(() => overlay.classList.add('hidden'), 300);
      }
    } else {
      if (isSidebarOpenDesktop) {
        sidebar.style.width = '0px';
        sidebar.style.overflow = 'hidden';
        isSidebarOpenDesktop = false;
      } else {
        sidebar.style.width = '16rem';
        sidebar.style.overflow = 'visible';
        isSidebarOpenDesktop = true;
      }
    }
  }
  window.toggleSidebar = toggleSidebar;
  hamburger.onclick = toggleSidebar;
  mobileCloseBtn.onclick = toggleSidebar;
  overlay.onclick = toggleSidebar;

  /* Search */
  const toggleSearchBtn = document.getElementById('toggleSearchBtn');
  const searchInput = document.getElementById('searchInput');
  toggleSearchBtn.onclick = () => {
      searchInput.classList.toggle('hidden');
      if (!searchInput.classList.contains('hidden')) searchInput.focus();
  };
  searchInput.addEventListener('input', (e) => {
      const term = e.target.value.toLowerCase();
      if (window.allChatsData) {
          const filtered = window.allChatsData.filter(c => c.title.toLowerCase().includes(term));
          renderChatList(filtered);
      }
  });

  /* Rendering (UPDATED WITH DELETE BUTTON) */
  window.renderChatList = (chats) => {
      const list = document.getElementById('recentChatsList');
      list.innerHTML = '';
      window.allChatsData = chats; 
      if (chats.length === 0) {
          list.innerHTML = '<div class="text-xs text-[var(--border)] p-2 italic">No history found.</div>';
          return;
      }
      chats.forEach(chat => {
          const container = document.createElement('div');
          container.className = "flex items-center group w-full mb-1 pr-2 rounded hover:bg-[var(--hover)] transition-all";
          container.dataset.id = chat.id;

          const btn = document.createElement('button');
          btn.className = `flex-grow text-left p-2 truncate text-xs md:text-sm border-l-2 border-transparent`;
          btn.innerHTML = `<div class="font-medium truncate">${chat.title || 'New Chat'}</div><div class="text-[10px] opacity-50">${new Date(chat.updatedAt?.seconds * 1000 || Date.now()).toLocaleDateString()}</div>`;
          btn.onclick = () => window.loadChatHistory(chat.id);
          
          const delBtn = document.createElement('button');
          delBtn.className = "opacity-0 group-hover:opacity-100 p-1 text-gray-400 hover:text-red-500 transition-opacity";
          delBtn.innerHTML = '<i class="ph-trash"></i>';
          delBtn.onclick = (e) => { e.stopPropagation(); window.deleteChat(chat.id); };

          container.appendChild(btn);
          container.appendChild(delBtn);
          list.appendChild(container);
      });
      if (window.currentChatId) highlightActiveChat(window.currentChatId);
  };

 window.highlightActiveChat = (id) => {
    document.querySelectorAll('#recentChatsList > div').forEach(div => {
        const btn = div.querySelector('button');
        // The fix: Add "if (btn)" to ensure the button exists before touching it
        if (btn) {
            if (div.dataset.id === id) {
                btn.classList.add('active-chat');
            } else {
                btn.classList.remove('active-chat');
            }
        }
    });
}
  window.addMessageToUI = (content, sender="ai", isImage=false, messageId=null) => {
    const welcome = document.getElementById('welcomeMessage');
    if(welcome) welcome.remove();

    const div = document.createElement('div');
    div.className = `chat-bubble p-3 rounded-lg max-w-[90%] mb-4 ${sender==='user' ? 'ml-auto bg-[var(--user-msg)] text-[var(--text)] border-none' : ''}`;
    div.dataset.messageId = messageId || crypto.randomUUID();
    
    let innerHTML = '';
    if(isImage) {
        innerHTML = `<img src="${content}" class="message-content max-w-full rounded-lg mb-2 border border-white/20" style="max-height: 200px;">`;
    } else {
        innerHTML = `<p class="message-content whitespace-pre-wrap leading-relaxed">${content}</p>`; 
    }

    if (sender === 'ai') {
        innerHTML += `
        <div class="ai-actions message-actions">
            <button class="action-btn" onclick="copyToClipboard(this)" title="Copy"><i class="ph-copy"></i> Copy</button>
            <button class="action-btn" onclick="regenerateResponse(this)" title="Regenerate"><i class="ph-arrows-clockwise"></i> Regenerate</button>
             <button class="action-btn" onclick="saveTextFile(this)" title="Save as Text"><i class="ph-download-simple"></i> Save</button>
        </div>`;
    } else if (!isImage) { 
        innerHTML += `
        <div class="user-actions message-actions" style="display: flex;">
            <button class="action-btn" onclick="copyToClipboard(this)" title="Copy"><i class="ph-copy"></i> Copy</button>
            <button class="action-btn" onclick="editMessage(this)" title="Edit"><i class="ph-pencil-simple"></i> Edit</button>
        </div>`;
    }
    div.innerHTML = innerHTML;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
    return div;
  };

  /* Global Actions Logic */
  window.copyToClipboard = (btn) => {
      const textElement = btn.closest('.chat-bubble').querySelector('.message-content');
      let text = textElement ? textElement.innerText : '';
      if (!text) {
          const img = btn.closest('.chat-bubble').querySelector('.message-content');
          if(img && img.tagName === 'IMG') text = `[Image: ${img.src}]`;
      }
      navigator.clipboard.writeText(text).then(() => {
          const icon = btn.querySelector('i');
          icon.className = 'ph-check';
          setTimeout(() => icon.className = 'ph-copy', 2000);
      }).catch(err => console.error('Could not copy text: ', err));
  };

  window.saveTextFile = (btn) => {
      const text = btn.closest('.chat-bubble').querySelector('.message-content').innerText;
      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'groq_response.txt'; a.click();
      URL.revokeObjectURL(url);
  };

  window.regenerateResponse = (btn) => {
     const aiBubble = btn.closest('.chat-bubble');
     let prevUserBubble = aiBubble.previousElementSibling;
     while(prevUserBubble && prevUserBubble.classList.contains('ml-auto') === false) {
         prevUserBubble = prevUserBubble.previousElementSibling;
     }
     if(prevUserBubble) {
         const text = prevUserBubble.querySelector('.message-content').innerText;
         aiBubble.remove();
         triggerAIRequest(text);
     }
  };

  window.editMessage = (btn) => {
      const bubble = btn.closest('.chat-bubble');
      const contentP = bubble.querySelector('.message-content');
      const actions = bubble.querySelector('.user-actions');
      const originalText = contentP.innerText;
      
      contentP.style.display = 'none';
      actions.style.display = 'none';

      const textarea = document.createElement('textarea');
      textarea.className = 'w-full p-2 border rounded-lg border-[var(--border)] bg-[var(--bg)] resize-none focus:outline-none focus:ring-1 focus:ring-[var(--accent)] text-sm md:text-base';
      textarea.rows = Math.max(3, originalText.split('\n').length + 1);
      textarea.value = originalText;
      textarea.style.minHeight = '60px';

      const saveBtn = document.createElement('button');
      saveBtn.className = 'px-3 py-1 mr-2 rounded bg-[var(--accent)] text-white hover:opacity-90 transition flex items-center gap-1';
      saveBtn.innerHTML = '<i class="ph-check"></i> Save';
      saveBtn.onclick = () => {
          if (textarea.value.trim()) contentP.innerText = textarea.value.trim();
          restore();
      };

      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'px-3 py-1 rounded border border-[var(--border)] hover:bg-[var(--hover)] transition flex items-center gap-1';
      cancelBtn.innerHTML = '<i class="ph-x"></i> Cancel';
      cancelBtn.onclick = () => { contentP.innerText = originalText; restore(); };
      
      const wrapper = document.createElement('div');
      wrapper.className = 'edit-wrapper mt-2 flex justify-end';
      wrapper.append(cancelBtn, saveBtn);

      bubble.insertBefore(textarea, actions);
      bubble.insertBefore(wrapper, actions);
      textarea.focus();

      function restore(){
          textarea.remove();
          wrapper.remove();
          contentP.style.display = 'block';
          actions.style.display = 'flex';
      }
  };

  function showTyping() {
      const div = document.createElement('div');
      div.id = 'typingIndicator';
      div.className = 'chat-bubble p-3 rounded-lg w-fit mb-4';
      div.innerHTML = `<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
  }
  function removeTyping() { const el = document.getElementById('typingIndicator'); if(el) el.remove(); }

  /* --- Send Logic (UPDATED FOR FIREBASE) --- */
  sendBtn.onclick = handleSend;
  userInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
    if(this.value === '') this.style.height = 'auto';
  });
  
  userInput.addEventListener('keypress', (e) => {
    const enterToSend = document.getElementById('enterToSendToggle').checked;
    if (enterToSend && e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  });

  async function handleSend() {
    const text = userInput.value.trim();
    if(!text && !currentFile) return;
    
    if (currentFile) {
        window.addMessageToUI(currentFile.data, 'user', true);
        if (window.saveMessageToFirestore) window.saveMessageToFirestore(currentFile.data, 'user', true);
    }
    if (text) {
        window.addMessageToUI(text, 'user');
        if (window.saveMessageToFirestore) window.saveMessageToFirestore(text, 'user', false);
    }
    
    const payloadText = text;
    const payloadFile = currentFile; 
    userInput.value = '';
    userInput.style.height = 'auto';
    clearAttachment();

    await triggerAIRequest(payloadText, payloadFile);
  }
  
  async function triggerAIRequest(text, fileData = null) {
      showTyping();
      try {
        let systemPrompt = localStorage.getItem('systemPrompt') || "You are a helpful AI.";
        const temp = parseFloat(localStorage.getItem('temp') || '0.7');
        const maxTokens = parseInt(localStorage.getItem('maxTokens') || '2048');
        const topP = parseFloat(localStorage.getItem('topP') || '0.9');
        const stopSeq = localStorage.getItem('stopSeq') || '';
        const modelName = modelSelect.options[modelSelect.selectedIndex].text;

        const contents = [];
        const parts = [];
        
        if (fileData) {
            parts.push({
                inline_data: { mime_type: fileData.type, data: fileData.data.split(',')[1] }
            });
        }
        
        parts.push({ text: `${systemPrompt}\n\n(User selected model: ${modelName})\n\n${text}` });
        contents.push({ role: "user", parts: parts });

        const payload = { 
            contents: contents,
            generationConfig: {
                temperature: temp,
                maxOutputTokens: maxTokens,
                topP: topP,
            }
        };
        
        if(stopSeq.trim()) {
            payload.generationConfig.stopSequences = stopSeq.split(',').map(s => s.trim());
        }

        const response = await fetch(GEMINI_ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const data = await response.json();
        removeTyping();

        if (data.error) {
            window.addMessageToUI(`Error: ${data.error.message}`, 'ai');
            return;
        }

        const aiText = data.candidates[0].content.parts[0].text;
        window.addMessageToUI(aiText, 'ai');
        if (window.saveMessageToFirestore) window.saveMessageToFirestore(aiText, 'ai', false);

    } catch (err) {
        removeTyping();
        window.addMessageToUI("Error connecting to AI service. " + err.message, 'ai');
    }
  }

  /* --- Attachments --- */
  const fileInput = document.getElementById('fileInput');
  const addPhotoBtn = document.getElementById('addPhotoBtn');
  const addFileBtn = document.getElementById('addFileBtn');
  const attachmentPreview = document.getElementById('attachmentPreview');
  const previewImg = document.getElementById('previewImg');
  const fileName = document.getElementById('fileName');
  const removeAttachment = document.getElementById('removeAttachment');

  function triggerFileUpload() { fileInput.click(); }
  addPhotoBtn.onclick = triggerFileUpload;
  addFileBtn.onclick = triggerFileUpload;

  fileInput.onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
          currentFile = { name: file.name, type: file.type, data: e.target.result };
          attachmentPreview.classList.remove('hidden');
          fileName.textContent = file.name;
          if(file.type.startsWith('image/')) {
              previewImg.src = e.target.result;
              previewImg.classList.remove('hidden');
          } else {
              previewImg.classList.add('hidden');
          }
          document.getElementById('plusMenu').classList.add('hidden');
      };
      reader.readAsDataURL(file);
  };

  function clearAttachment() {
      currentFile = null;
      fileInput.value = '';
      attachmentPreview.classList.add('hidden');
  }
  removeAttachment.onclick = clearAttachment;

  /* --- Plus Menu --- */
  const plusBtn = document.getElementById('plusMenuBtn');
  const plusMenu = document.getElementById('plusMenu');
  plusBtn.onclick = (e) => { e.stopPropagation(); plusMenu.classList.toggle('hidden'); };
  document.addEventListener('click', (e) => {
    if (!plusBtn.contains(e.target) && !plusMenu.contains(e.target)) plusMenu.classList.add('hidden');
  });

  /* --- Settings Logic --- */
  const settingsBtn = document.getElementById('settingsBtn');
  const settingsModal = document.getElementById('settingsModal');
  const settingsBackdrop = document.getElementById('settingsBackdrop');
  const closeSettings = document.getElementById('closeSettings');
  const saveSettingsBtn = document.getElementById('saveSettingsBtn');

  const tempInput = document.getElementById('tempInput');
  const topPInput = document.getElementById('topPInput');
  tempInput.oninput = () => document.getElementById('tempValue').innerText = tempInput.value;
  topPInput.oninput = () => document.getElementById('topPValue').innerText = topPInput.value;

  document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.onclick = () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');
      };
  });

  function toggleSettings() { 
      settingsModal.classList.toggle('hidden'); 
      if (!settingsModal.classList.contains('hidden')) loadSettingsToUI();
  }
  
  function loadSettingsToUI() {
      document.getElementById('systemPrompt').value = localStorage.getItem('systemPrompt') || "You are a helpful AI assistant powered by Groq.";
      document.getElementById('defaultModelSetting').value = localStorage.getItem('defaultModel') || 'llama-3.3-70b-versatile';
      tempInput.value = localStorage.getItem('temp') || '0.7';
      document.getElementById('tempValue').innerText = tempInput.value;
      document.getElementById('maxTokensInput').value = localStorage.getItem('maxTokens') || '2048';
      topPInput.value = localStorage.getItem('topP') || '0.9';
      document.getElementById('topPValue').innerText = topPInput.value;
      document.getElementById('stopSequencesInput').value = localStorage.getItem('stopSeq') || '';
      document.getElementById('fontSizeSelect').value = localStorage.getItem('fontSize') || 'medium';
      document.getElementById('compactModeToggle').checked = localStorage.getItem('compactMode') === 'true';
      document.getElementById('enterToSendToggle').checked = localStorage.getItem('enterToSend') !== 'false'; 
      document.getElementById('showUserIdToggle').checked = localStorage.getItem('showUserId') === 'true';
      estimateStorage();
  }

  function saveSettingsToStorage() {
      localStorage.setItem('systemPrompt', document.getElementById('systemPrompt').value);
      const defModel = document.getElementById('defaultModelSetting').value;
      localStorage.setItem('defaultModel', defModel);
      if(!window.currentChatId) modelSelect.value = defModel;
      localStorage.setItem('temp', tempInput.value);
      localStorage.setItem('maxTokens', document.getElementById('maxTokensInput').value);
      localStorage.setItem('topP', topPInput.value);
      localStorage.setItem('stopSeq', document.getElementById('stopSequencesInput').value);
      const fs = document.getElementById('fontSizeSelect').value;
      localStorage.setItem('fontSize', fs);
      document.documentElement.dataset.font = fs;
      const compact = document.getElementById('compactModeToggle').checked;
      localStorage.setItem('compactMode', compact);
      document.documentElement.dataset.compact = compact;
      localStorage.setItem('enterToSend', document.getElementById('enterToSendToggle').checked);
      const showId = document.getElementById('showUserIdToggle').checked;
      localStorage.setItem('showUserId', showId);
      if(showId) document.getElementById('userIdContainer').classList.remove('hidden');
      else document.getElementById('userIdContainer').classList.add('hidden');
      toggleSettings();
  }

  settingsBtn.onclick = toggleSettings;
  settingsBackdrop.onclick = toggleSettings;
  closeSettings.onclick = toggleSettings;
  saveSettingsBtn.onclick = saveSettingsToStorage;

  (function applyInitialSettings() {
      document.documentElement.dataset.font = localStorage.getItem('fontSize') || 'medium';
      document.documentElement.dataset.compact = localStorage.getItem('compactMode');
      if(localStorage.getItem('showUserId') === 'true') document.getElementById('userIdContainer').classList.remove('hidden');
      modelSelect.value = localStorage.getItem('defaultModel') || 'llama-3.3-70b-versatile';
  })();

  /* --- Storage Logic --- */
  async function estimateStorage() {
      let limit = 500 * 1024 * 1024; 
      if (navigator.storage && navigator.storage.estimate) {
          try { const est = await navigator.storage.estimate(); if (est.quota) limit = est.quota; } catch(e){}
      }
      document.getElementById('storageCapacityEl').textContent = formatBytes(limit);
      let used = 0;
      for(let key in localStorage) {
          if(localStorage.hasOwnProperty(key)) used += (localStorage[key].length * 2);
      }
      document.getElementById('storageUsedEl').textContent = formatBytes(used);
      document.getElementById('storageFillEl').style.width = Math.min(100, (used / limit * 100)) + '%';
  }
  function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024; const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  /* --- New Chat --- */
  document.getElementById('newChatBtn').onclick = () => {
      window.currentChatId = null;
      if (window.chatListenerUnsubscribe) window.chatListenerUnsubscribe();
      messages.innerHTML = `
            <div id="welcomeMessage" class="chat-bubble p-6 rounded-lg max-w-2xl mx-auto mt-10 text-center border-none bg-gradient-to-br from-[var(--panel)] to-[var(--bg)] shadow-lg">
                <div class="bg-[var(--accent)] w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="ph-lightning text-2xl text-white"></i>
                </div>
                <h3 class="text-xl font-bold mb-2">Welcome to Groq Chat</h3>
                <p class="opacity-70 mb-4">Experience ultra-fast inference with Llama 3 & 4 models.</p>
            </div>`;
      highlightActiveChat(null);
      if(window.innerWidth < 1024) toggleSidebar();
  };

 window.loadRecentChats = () => {
    // 1. Check if Firebase script has provided the loader
    // We check for both possible names to be safe
    const loader = window.fetchChatsFromFirestore || window.triggerFirebaseLoad;

    if (typeof loader === "function") {
        console.log("Found Firebase loader, fetching chats...");
        loader();
    } else {
        console.warn("Firebase logic not ready yet. Retrying in 500ms...");
        // If Firebase isn't ready yet, try again in half a second
        setTimeout(window.loadRecentChats, 500);
    }
};

// Auto-start the loading process once the UI is ready
window.addEventListener('DOMContentLoaded', () => {
    window.loadRecentChats();
});
</script>
</body>
</html>
